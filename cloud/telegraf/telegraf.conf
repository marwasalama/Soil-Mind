# =========================================================
# Telegraf MQTT → InfluxDB
# Smart Farm – Production Ready (Telemetry + Status + Control)
# =========================================================

[agent]
  interval = "5s"
  flush_interval = "5s"
  hostname = ""

# =========================================================
# TELEMETRY  (QoS 0)
# Topic: farm/<site>/<node>/telemetry
# =========================================================
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics  = ["farm/+/+/telemetry"]
  qos = 0
  connection_timeout = "30s"
  data_format = "json_v2"

  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "telemetry"

    [[inputs.mqtt_consumer.json_v2.tag]]  path = "site" rename = "site"
    [[inputs.mqtt_consumer.json_v2.tag]]  path = "node" rename = "node"

    [[inputs.mqtt_consumer.json_v2.field]] path="soil_moisture" type="float"
    [[inputs.mqtt_consumer.json_v2.field]] path="temperature"   type="float"
    [[inputs.mqtt_consumer.json_v2.field]] path="humidity"      type="float"
    [[inputs.mqtt_consumer.json_v2.field]] path="ph"            type="float"

    # Optional NPK (won't error if missing)
    [[inputs.mqtt_consumer.json_v2.field]] path="n" type="float" optional=true
    [[inputs.mqtt_consumer.json_v2.field]] path="p" type="float" optional=true
    [[inputs.mqtt_consumer.json_v2.field]] path="k" type="float" optional=true

# =========================================================
# STATUS (QoS 1)
# Topic: farm/<site>/<node>/status
# Fields: online فقط
# =========================================================
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics  = ["farm/+/+/status"]
  qos = 1
  connection_timeout = "30s"
  data_format = "json_v2"

  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "control"

    [[inputs.mqtt_consumer.json_v2.tag]]  path = "site" rename = "site"
    [[inputs.mqtt_consumer.json_v2.tag]]  path = "node" rename = "node"

    [[inputs.mqtt_consumer.json_v2.field]] path="online" type="bool"

# =========================================================
# CONTROL / DECISION (QoS 1)
# Topic: farm/<site>/<node>/control
# Fields: irrigation + decision + reason + thresholds
# =========================================================
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics  = ["farm/+/+/control"]
  qos = 1
  connection_timeout = "30s"
  data_format = "json_v2"

  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "control"

    [[inputs.mqtt_consumer.json_v2.tag]]  path = "site" rename = "site"
    [[inputs.mqtt_consumer.json_v2.tag]]  path = "node" rename = "node"

    [[inputs.mqtt_consumer.json_v2.field]] path="online" type="bool" optional=true
    [[inputs.mqtt_consumer.json_v2.field]] path="irrigation" type="bool"
    [[inputs.mqtt_consumer.json_v2.field]] path="decision"   type="string"
    [[inputs.mqtt_consumer.json_v2.field]] path="reason"     type="string"
    [[inputs.mqtt_consumer.json_v2.field]] path="soil_moisture" type="float"
    [[inputs.mqtt_consumer.json_v2.field]] path="min_th" type="float"
    [[inputs.mqtt_consumer.json_v2.field]] path="max_th" type="float"

# =========================================================
# OUTPUT → InfluxDB v2
# =========================================================
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "soilmind-token-123"
  organization = "soilmind"
  bucket = "smartfarm"
